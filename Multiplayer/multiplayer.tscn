[gd_scene load_steps=9 format=3 uid="uid://2di75bhoq6qp"]

[ext_resource type="Script" uid="uid://by533e7pjwwlq" path="res://Multiplayer/multiplayer.gd" id="1_vctqx"]
[ext_resource type="PackedScene" uid="uid://cqq2hhmfu7rgp" path="res://tank_player.tscn" id="2_5njq1"]
[ext_resource type="PackedScene" uid="uid://bjipf33trn6xx" path="res://GUI/player_list.tscn" id="2_vctqx"]
[ext_resource type="Texture2D" uid="uid://c8vd6ne6h853c" path="res://main_map/assets/map biomes.png" id="3_vctqx"]
[ext_resource type="PackedScene" uid="uid://bfhot2v8m2tus" path="res://bullet.tscn" id="3_wt4ht"]

[sub_resource type="GDScript" id="GDScript_wt4ht"]
script/source = "extends Node2D

@export var tank_scene: PackedScene
@onready var minigame_container = get_node(\".\")

# Spawning all tanks for the players
func _ready():
	if multiplayer.is_server():
		# Wait until all players are loaded before spawning tanks
		NetworkManager.player_connected.connect(_on_peer_connected)

# Function to spawn a specific player's tank
@rpc(\"authority\")
func spawn_tank(id):
	if multiplayer.is_server():
		if tank_scene == null:
			print(\"❌ Error: tank_scene is not set!\")
			return

		print(\"✅ Spawning tank for player:\", id)
		var tank = tank_scene.instantiate()  # Local instantiation within function
		tank.set_multiplayer_authority(id)  # Assign correct authority
		minigame_container.add_child(tank)  # Add tank to minigame container

# Server-side function to spawn tanks for all players
func spawn_all_tanks():
	print(\"Spawning tanks for all players...\")
	# Ensure all players are fully loaded before spawning
	for peer_id in multiplayer.get_peers():
		spawn_tank(peer_id)  # Spawn tank for each peer (player)

# Handle the player load notification
@rpc(\"any_peer\", \"reliable\", \"call_local\")
func player_loaded():
	if multiplayer.is_server():
		# This will call spawn_all_tanks once all players have loaded
		print(\"All players loaded, spawning tanks...\")
		spawn_all_tanks()

# When a new player connects, we can check if all players are ready
func _on_peer_connected(id):
	# Send a signal to notify this player that they have finished loading
	print(\"Player %d connected, notifying that they are ready.\" % id)
	player_loaded()  # Send the player_loaded notification to all peers
"

[sub_resource type="RectangleShape2D" id="RectangleShape2D_wt4ht"]
size = Vector2(953, 492)

[sub_resource type="GDScript" id="GDScript_5njq1"]
script/source = "extends MultiplayerSpawner

func get_spawn_position() -> Vector2:
	var spawn_points = get_children().filter(func(c): return c is Marker2D)
	if spawn_points.is_empty():
		return Vector2(randf_range(0, 1024), randf_range(0, 600))
	return spawn_points.pick_random().global_position
"

[node name="LobbyScene" type="Node2D"]
script = ExtResource("1_vctqx")
tank_scene = ExtResource("2_5njq1")
bullet_scene = ExtResource("3_wt4ht")

[node name="CanvasLayer" type="CanvasLayer" parent="."]
follow_viewport_enabled = true

[node name="background" type="TextureRect" parent="CanvasLayer"]
z_index = -11
texture_filter = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
size_flags_horizontal = 6
size_flags_vertical = 3
texture = ExtResource("3_vctqx")
metadata/_edit_lock_ = true

[node name="tankGame" type="Area2D" parent="CanvasLayer"]
position = Vector2(585, 326)
script = SubResource("GDScript_wt4ht")
tank_scene = ExtResource("2_5njq1")

[node name="CollisionShape2D" type="CollisionShape2D" parent="CanvasLayer/tankGame"]
position = Vector2(-6, -10)
shape = SubResource("RectangleShape2D_wt4ht")

[node name="PlayerList" parent="CanvasLayer" instance=ExtResource("2_vctqx")]
z_index = 6
scale = Vector2(11.46, 16.2026)

[node name="TankSpawner" type="MultiplayerSpawner" parent="."]
_spawnable_scenes = PackedStringArray("uid://cqq2hhmfu7rgp")
spawn_path = NodePath("../CanvasLayer/tankGame")
script = SubResource("GDScript_5njq1")

[node name="Marker2D" type="Marker2D" parent="TankSpawner"]
position = Vector2(911, 125)

[node name="Marker2D2" type="Marker2D" parent="TankSpawner"]
position = Vector2(132, 122)

[node name="Marker2D3" type="Marker2D" parent="TankSpawner"]
position = Vector2(585, 358)

[node name="Marker2D4" type="Marker2D" parent="TankSpawner"]
position = Vector2(1017, 489)

[node name="BulletSpawner" type="MultiplayerSpawner" parent="."]
_spawnable_scenes = PackedStringArray("uid://bfhot2v8m2tus")
spawn_path = NodePath("../CanvasLayer/tankGame")
script = SubResource("GDScript_5njq1")
